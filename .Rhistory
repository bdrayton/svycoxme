my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
my_beta = c(1, -0.7, 0.5)
my_theta = 2
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
b <- attr(sample_data, "random_effects")
my_params <- c(my_beta[seq_along(my_X)], b)
# my_hessian <- ppl_hessian(parms = my_params, X = my_X, t = t,
#                           cluster = "M", dij = stat, data = sample_data,
#                           theta = my_theta)
my_K_ppl <- bb(parms = my_params, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data,
theta = my_theta, return_matrix = TRUE)
est_theta(b, my_K_ppl)
devtools::load_all(".")
my_beta = c(1, -0.7, 0.5)
my_theta = 1
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
fit <- survival::coxph(survival::Surv(t, stat) ~ X1 + X2 + X3, data = sample_data)
nb <- dplyr::n_distinct(sample_data$M)
start_parameters = c(coef(fit), rep(0, nb))
names(start_parameters) <- c(my_X, paste0("Z", seq_len(nb)))
debugonce(estimate_parameters)
current_estimates <- estimate_parameters(start_parms = start_parameters, theta = 1, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data)
max_iter = 10
convergence_threshold = 0.000001
estimate_history <- list(current_estimates)
for (i in 1:max_iter) {
current_estimates <- estimate_parameters(start_parms = current_estimates$new_parms,
theta = current_estimates$new_theta,
X = my_X,
t = t,
cluster = "M",
dij = stat,
data = sample_data)
estimate_history[[i+1]] <- current_estimates
biggest_diff = max(abs(c(estimate_history[[i]]$new_theta - estimate_history[[i+1]]$new_theta,
estimate_history[[i]]$new_parms - estimate_history[[i+1]]$new_parms)), na.rm = TRUE)
if(biggest_diff <= convergence_threshold){
cat("converged in", i, "iterations")
break
}
}
tail(estimate_history, 1)
current_estimates <- estimate_parameters(start_parms = start_parameters, theta = 1, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data)
max_iter = 100
convergence_threshold = 0.000001
estimate_history <- list(current_estimates)
for (i in 1:max_iter) {
current_estimates <- estimate_parameters(start_parms = current_estimates$new_parms,
theta = current_estimates$new_theta,
X = my_X,
t = t,
cluster = "M",
dij = stat,
data = sample_data)
estimate_history[[i+1]] <- current_estimates
biggest_diff = max(abs(c(estimate_history[[i]]$new_theta - estimate_history[[i+1]]$new_theta,
estimate_history[[i]]$new_parms - estimate_history[[i+1]]$new_parms)), na.rm = TRUE)
if(biggest_diff <= convergence_threshold){
cat("converged in", i, "iterations")
break
}
}
tail(estimate_history, 1)
coxme_fit <- coxme::coxme(survival::Surv(t, stat) ~ X1 + X2 + X3 + (1 | M), data = sample_data)
c(coxme::VarCorr(coxme_fit),
coxme::fixef(coxme_fit),
coxme::ranef(coxme_fit))
c(coxme::VarCorr(coxme_fit),
coxme::fixef(coxme_fit),
coxme::ranef(coxme_fit)$M)
c(coxme::VarCorr(coxme_fit)$M,
coxme::fixef(coxme_fit),
coxme::ranef(coxme_fit))
c(coxme::VarCorr(coxme_fit)$M,
coxme::fixef(coxme_fit),
coxme::ranef(coxme_fit)$M)
tail(estimate_history, 1)
algo_fit <- tail(estimate_history, 1)
algo_fit[[1]]
unlist(algo_fit)
cbind(
c(coxme::VarCorr(coxme_fit)$M,
coxme::fixef(coxme_fit),
coxme::ranef(coxme_fit)$M),
unlist(algo_fit))
attr(sample_data, "random_effects")
data.frame(
true_vals = c(my_theta, my_beta, attr(sample_data, "random_effects")),
coxme = c(coxme::VarCorr(coxme_fit)$M,
coxme::fixef(coxme_fit),
coxme::ranef(coxme_fit)$M),
my_ests = unlist(algo_fit))
my_beta = c(1, -0.7, 0.5)
my_theta = 1
my_k = 10
my_nk = 10
my_X = c("X1", "X2", "X3")
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
fit <- survival::coxph(survival::Surv(t, stat) ~ X1 + X2 + X3, data = sample_data)
nb <- dplyr::n_distinct(sample_data$M)
start_parameters = c(coef(fit), rep(0, nb))
names(start_parameters) <- c(my_X, paste0("Z", seq_len(nb)))
current_estimates <- estimate_parameters(start_parms = start_parameters, theta = 1, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data)
max_iter = 100
convergence_threshold = 0.000001
estimate_history <- list(current_estimates)
for (i in 1:max_iter) {
current_estimates <- estimate_parameters(start_parms = current_estimates$new_parms,
theta = current_estimates$new_theta,
X = my_X,
t = t,
cluster = "M",
dij = stat,
data = sample_data)
estimate_history[[i+1]] <- current_estimates
biggest_diff = max(abs(c(estimate_history[[i]]$new_theta - estimate_history[[i+1]]$new_theta,
estimate_history[[i]]$new_parms - estimate_history[[i+1]]$new_parms)), na.rm = TRUE)
if(biggest_diff <= convergence_threshold){
cat("converged in", i, "iterations")
break
}
}
sample_data <- one_dataset(control = list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
fit <- survival::coxph(survival::Surv(t, stat) ~ X1 + X2 + X3, data = sample_data)
nb <- dplyr::n_distinct(sample_data$M)
start_parameters = c(coef(fit), rep(0, nb))
names(start_parameters) <- c(my_X, paste0("Z", seq_len(nb)))
# debugonce(estimate_parameters)
current_estimates <- estimate_parameters(start_parms = start_parameters, theta = 1, X = my_X, t = t,
cluster = "M", dij = stat, data = sample_data)
max_iter = 100
convergence_threshold = 0.000001
estimate_history <- list(current_estimates)
for (i in 1:max_iter) {
current_estimates <- estimate_parameters(start_parms = current_estimates$new_parms,
theta = current_estimates$new_theta,
X = my_X,
t = t,
cluster = "M",
dij = stat,
data = sample_data)
estimate_history[[i+1]] <- current_estimates
biggest_diff = max(abs(c(estimate_history[[i]]$new_theta - estimate_history[[i+1]]$new_theta,
estimate_history[[i]]$new_parms - estimate_history[[i+1]]$new_parms)), na.rm = TRUE)
if(biggest_diff <= convergence_threshold){
cat("converged in", i, "iterations")
break
}
}
beta = c(1, -0.7, 0.5)
my_theta = 1
devtools::load_all(".")
my_beta = c(1, -0.7, 0.5)
my_theta = 1
my_k = 50
my_nk = 10
ds <- one_dataset(list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
fit <- coxme::coxme(survival::Surv(t, stat) ~ X1 + X2 + X3 + (1|M), data = ds)
est_theta <- coxme::VarCorr(fit)$M
D = est_theta * diag(my_k)
est_parms <- c(coxme::fixef(fit), coxme::ranef(fit)$M)
names(est_parms) <- paste0(rep(c("X", "Z"), c(3, my_k)), c(1:3, seq_len(my_k)))
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
t = t, dij = stat, D =  D, data = ds)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat, D =  D, data = ds)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta, data = ds)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
(fit$loglik["Penalized"] - my_loglik) < 1e-10
fit$loglik["Penalized"] - my_loglik
fit$loglik["Penalized"]
my_loglik
fit$penalty == attr(my_loglik, "penalty")
attr(my_loglik, "penalty")
fit$penalty
devtools::load_all(".")
debugonce(lp)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
fit$loglik["Penalized"] - my_loglik
devtools::load_all(".")
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
debugonce(lp)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
debugonce(lp)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
debug(sortAndIndex)
t
sortVars
devtools::load_all(".")
my_beta = c(1, -0.7, 0.5)
my_theta = 1
my_k = 50
my_nk = 10
ds <- one_dataset(list(k = my_k, nk = my_nk, beta = my_beta, theta = my_theta))
fit <- coxme::coxme(survival::Surv(t, stat) ~ X1 + X2 + X3 + (1|M), data = ds)
est_theta <- coxme::VarCorr(fit)$M
D = est_theta * diag(my_k)
est_parms <- c(coxme::fixef(fit), coxme::ranef(fit)$M)
names(est_parms) <- paste0(rep(c("X", "Z"), c(3, my_k)), c(1:3, seq_len(my_k)))
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = my_theta,
data = ds)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = est_theta,
data = ds)
debugonce(lp)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = est_theta,
data = ds)
debugonce(lp)
debugonce(sortAndIndex)
my_loglik <- lp(parms = est_parms,
X = c("X1", "X2", "X3"),
cluster = "M",
t = t, dij = stat,
theta = est_theta,
data = ds)
data %>%
dplyr::arrange(dplyr::across({{ sort_vars }}))
data
data %>% dplyr::arrange(t)
data %>% dplyr::arrange(dplyr::across(t))
devtools::load_all(".")
