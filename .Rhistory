strat4 == 2 ~ n/160,
strat4 == 3 ~ n/120,
TRUE ~ 1))
nwts_join <- dplyr::left_join(nwts, select(s_counts, strata, strat4, weight)) |>
dplyr::mutate(id = dplyr::row_number())
nwts_join <- dplyr::left_join(nwts, dplyr::select(s_counts, strata, strat4, weight)) |>
dplyr::mutate(id = dplyr::row_number())
nwts_pop <- dplyr::select(nwts_join, instit, age_bin, stage, relaps,
trel, id, histol, weight, strat4, tumdiam)
# draw the complex sample.
nwts_samp <- dplyr::bind_rows(
dplyr::filter(nwts_pop, strat4 == 1) |>
dplyr::slice_sample(n = 120),
dplyr::filter(nwts_pop, strat4 == 2) |>
dplyr::slice_sample(n = 160),
dplyr::filter(nwts_pop, strat4 == 3) |>
dplyr::slice_sample(n = 120),
dplyr::filter(nwts_pop, strat4 == 4))
nwts_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_samp)
m0 <- svycoxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam, design = nwts_design)
pop_totals <- colSums(model.matrix(~ relaps + instit + age_bin + stage, data = nwts_pop))
pop_totals
pop_totals <- colSums(model.matrix(~ relaps + instit + age_bin + stage*tumdiam, data = nwts_pop))
pop_totals
cal_form <- ~ relaps + instit + age_bin + stage*tumdiam
pop_totals <- colSums(model.matrix(cal_form, data = nwts_pop))
# calibrate the weights using pop totals
var_cal <- calibrate(nwts_design, formula = cal_form,
pop=pop_totals, bounds = c(0.1, 10))
# fit a model using the calibrated design
m1 <- svycoxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam, design = var_cal)
popmodel <- coxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam,
data = nwts_pop, na.action = na.exclude())
popmodel <- coxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam,
data = nwts_pop, na.action = na.exclude)
# extract the dfbetas from this pop-level fit.
inffun <- dfbeta(popmodel)
# extract the dfbetas from this pop-level fit.
inffun <- resid(popmodel, "dfbeta")
# add the influence functions to the design
index <- match(nwts_samp$id, nwts_pop$id)
names(inffun)
colnames(inffun)
ncol(inffun)
names(pop_totals)
nwts_design_if <- update(nwts_design,
if1 = inffun[index, 1],
if2 = inffun[index, 2],
if3 = inffun[index, 3],
if4 = inffun[index, 4],
if5 = inffun[index, 5],
if6 = inffun[index, 6],
if7 = inffun[index, 7])
# extract the dfbetas from this pop-level fit.
inffun <- resid(popmodel, "dfbeta")
# add the influence functions to the design
index <- match(nwts_samp$id, nwts_pop$id)
nwts_design_if <- update(nwts_design,
if1 = inffun[index, 1],
if2 = inffun[index, 2],
if3 = inffun[index, 3],
if4 = inffun[index, 4],
if5 = inffun[index, 5],
if6 = inffun[index, 6],
if7 = inffun[index, 7])
ncol(inffun)
nwts_design_if <- update(nwts_design,
if1 = inffun[index, 1],
if2 = inffun[index, 2],
if3 = inffun[index, 3],
if4 = inffun[index, 4],
if5 = inffun[index, 5])
names(coef(popmodel))
# calibrate using the influence functions
if_cal <- calibrate(nwts_design_if,
formula = ~if1 + if2 + if3 + if4 + if5,
pop = c(pop_totals[1], if1 = 0, if2 = 0, if3 = 0, if4 = 0, if5 = 0))
# fit a model using the IF calibrated design
m2 <- svycoxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam, design = if_cal)
# Uncalibrated design
(m0_summary <- coef(summary(m0)))
# Calibrated with population variables
(m1_summary <- coef(summary(m1)))
# Calibrated with population influence functions
(m2_summary <- coef(summary(m2)))
str(m2_summary)
std_err <- Reduce(cbind, lapply(list(m0_summary, m1_summary, m2_summary), function(df) df[, "robust se"]))
# factor of reduction
round(matrix(std_err[ , 1], nr = 4, nc = 3) / std_err , 1)
std_err[ , 1]
# factor of reduction
round(matrix(std_err[ , 1], nr = 5, nc = 3) / std_err , 1)
# factor of reduction
round(matrix(std_err[ , 1], nr = 5, nc = 3) / std_err , 2)
m1_summary
m2_summary
m0_summary
# calibrate the weights using pop totals
var_cal <- calibrate(nwts_design, formula = cal_form,
pop=pop_totals) # dropped , bounds = c(0.1, 10)
# fit a model using the calibrated design
m1 <- svycoxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam, design = var_cal)
# Calibrated with population variables
(m1_summary <- coef(summary(m1)))
std_err <- Reduce(cbind, lapply(list(m0_summary, m1_summary, m2_summary), function(df) df[, "robust se"]))
# factor of reduction
round(matrix(std_err[ , 1], nr = 5, nc = 3) / std_err , 2)
# also consider
# data(nwts2ph, package = "addhazard")
data(nwtsco, package = "addhazard")
nwts <- nwtsco
names(nwts)
table(nwts$age>10)
table(nwts$age>1)
# also consider
# data(nwts2ph, package = "addhazard")
data(nwtsco, package = "addhazard")
nwts <- nwtsco
nwts <- nwtsco
# set up strata
nwts <- nwts |>
dplyr::mutate(instit = factor(instit, c(0, 1), labels = c("FH", "UH")),
stage4 = stage == 4,
stage = factor(stage, levels = 1:4,
labels = c("I-II", "I-II",
"III-IV", "III-IV")),
age_bin = factor(0 + age<1,
labels = c("<1Yr", ">=1Yrs")),
strata =interaction(instit, stage, age_bin, relaps))
table(nwts$stage4)
## collapse smallest 13 strata together.
s_counts <- nwts |>
dplyr::count(strata) |>
dplyr::arrange(desc(n)) |>
dplyr::mutate(rank = dplyr::row_number()) |>
dplyr::mutate(strat4 = dplyr::if_else(rank <= 3, rank, 4L)) |>
dplyr::group_by(strat4) |>
dplyr::mutate(weight = dplyr::case_when(strat4 == 1 ~ n/120,
strat4 == 2 ~ n/160,
strat4 == 3 ~ n/120,
TRUE ~ 1))
nwts_join <- dplyr::left_join(nwts, dplyr::select(s_counts, strata, strat4, weight)) |>
dplyr::mutate(id = dplyr::row_number())
nwts_pop <- nwts_join
# draw the complex sample.
nwts_samp <- dplyr::bind_rows(
dplyr::filter(nwts_pop, strat4 == 1) |>
dplyr::slice_sample(n = 120),
dplyr::filter(nwts_pop, strat4 == 2) |>
dplyr::slice_sample(n = 160),
dplyr::filter(nwts_pop, strat4 == 3) |>
dplyr::slice_sample(n = 120),
dplyr::filter(nwts_pop, strat4 == 4))
nwts_pop$in.subsample <- ntws_pop$id %in% ntws_samp$id
nwts_pop$in.subsample <- nwts_pop$id %in% nwts_samp$id
impmodel <- glm(histol~instit + age_bin + stage4*study, data = nwts_pop, subset = in.subsample, family = binomial )
nwts_pop$imphist <- predict(impmodel, newdata = nwts_pop, type = "response")
# replace predicted histology with actual histology where available (i.e. sampled children)
nwts_pop$imphist[nwts_pop$in.subsample] <- nwts$histol[nwts_pop$in.subsample]
# fit a model to the population data supplemented with the imputed histology
ifmodel <- coxph(Surv(trel, relaps) ~ imphist * age + stage * tumdiam, data = nwts_pop)
inffun <- resid(ifmodel, "dfbeta")
colnames(inffun) <- paste0("if", seq(ncol(inffun)))
colnames(inffun)
nwts_pop_if <- cbind(nwts_pop, inffun)
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4)
# design with pop data
if_design <- twophase(id = list(~1, ~1), subset = ~in.subsample,
strata = list(NULL, ~strat4), data = nwts_pop_if)
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4)
if_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_pop_if, subset = ~in.subsample)
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4)
pop_totals <- colSums(~ if1 + if2 + if3 + if4 + if5 + strat4, data = nwts_pop_if)
pop_totals <- colSums(model.matrix(~ if1 + if2 + if3 + if4 + if5 + strat4,
data = nwts_pop_if))
pop_totals
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4,
population = pop_totals)
# design with sample data. same as if_design
nwts_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_samp)
m0 <- svycoxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam, design = if_design)
cal_form <- ~ imphist * age + stage * tumdiam
pop_totals <- colSums(model.matrix(cal_form, data = nwts_pop))
# calibrate the weights using pop totals
var_cal <- calibrate(if_design, formula = cal_form,
pop=pop_totals) # dropped , bounds = c(0.1, 10)
# fit a model using the calibrated design
m1 <- svycoxph(Surv(trel, relaps) ~ histol + age_bin + stage*tumdiam, design = var_cal)
m1a <- svycoxph(Surv(trel, relaps) ~ histol + age_bin + stage*tumdiam, design = if_cal)
# fit the same model to the population
popmodel <- coxph(Surv(trel, relaps) ~ instit + age_bin + stage*tumdiam,
data = nwts_pop, na.action = na.exclude)
# Uncalibrated design
(m0_summary <- coef(summary(m0)))
if_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_pop_if, subset = ~in.subsample)
pop_totals <- colSums(model.matrix(~ if1 + if2 + if3 + if4 + if5 + strat4,
data = nwts_pop_if))
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4,
population = pop_totals)
# design with sample data. same as if_design
nwts_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_samp)
# fit a model using the uncalibrated design
m0 <- svycoxph(Surv(trel, relaps) ~  histol * age + stage * tumdiam, design = if_design)
cal_form <- ~ imphist * age + stage * tumdiam
pop_totals <- colSums(model.matrix(cal_form, data = nwts_pop))
# calibrate the weights using pop totals
var_cal <- calibrate(if_design, formula = cal_form,
pop=pop_totals) # dropped , bounds = c(0.1, 10)
# fit a model using the variable calibrated design
m1 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = var_cal)
# fit a model using the influence function calibrated design with imputation
m1a <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = if_cal)
nwts_pop_if <- cbind(nwts_pop, inffun)
if_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_pop_if, subset = ~in.subsample)
pop_totals <- colSums(model.matrix(~ if1 + if2 + if3 + if4 + if5 + strat4,
data = nwts_pop_if))
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4,
population = pop_totals)
# design with sample data. same as if_design
nwts_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_samp)
# fit a model using the uncalibrated design
m0 <- svycoxph(Surv(trel, relaps) ~  histol * age + stage * tumdiam, design = if_design)
cal_form <- ~ imphist * age + stage * tumdiam
pop_totals <- colSums(model.matrix(cal_form, data = nwts_pop))
# calibrate the weights using pop totals
var_cal <- calibrate(if_design, formula = cal_form,
pop=pop_totals) # dropped , bounds = c(0.1, 10)
# fit a model using the variable calibrated design
m1 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = var_cal)
# fit a model using the influence function calibrated design with imputation
m1a <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = if_cal)
# Uncalibrated design
(m0_summary <- coef(summary(m0)))
# Calibrated with population variables
(m1_summary <- coef(summary(m1)))
# Calibrated with population influence functions using imputed data
(m1a_summary <- coef(summary(m1a)))
# regular cox regression on the population data
m2 <- coxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, data = nwts_pop_if)
m2_summary <- coef(summary(m2))
m2_summary
### influence function calibration without imputation (instit swapped for histol)
popmodel <- coxph(Surv(trel, relaps) ~ instit * age + stage * tumdiam,
data = nwts_pop, na.action = na.exclude)
# extract the dfbetas from this pop-level fit.
inffun <- resid(popmodel, "dfbeta")
# add the influence functions to the design
index <- match(nwts_samp$id, nwts_pop$id)
nwts_design_if <- update(nwts_design,
if1 = inffun[index, 1],
if2 = inffun[index, 2],
if3 = inffun[index, 3],
if4 = inffun[index, 4],
if5 = inffun[index, 5])
# calibrate using the influence functions
if_cal <- calibrate(nwts_design_if,
formula = ~if1 + if2 + if3 + if4 + if5,
pop = c(pop_totals[1], if1 = 0, if2 = 0, if3 = 0, if4 = 0, if5 = 0))
# fit a model using the IF calibrated design
m3 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = if_cal)
m3_summary <- coef(summary(m3))
(m3_summary <- coef(summary(m3)))
m2_summary
m1a_summary
confint(m3)
confint(m2)
confint(m1a)
des <- svydesign(~1, probs = ~1, data = nwts_pop, fpc = nrow(nwts_pop))
nrow(nwts_pop)
des <- svydesign(~1, probs = ~1, data = nwts_pop)
des <- svydesign(~1, probs = ~1, data = nwts_pop, fpc = nrow(nwts_pop) + 1)
des <- svydesign(~1, probs = ~1, data = nwts_pop, fpc = nrow(nwts_pop) + 1000)
des <- svydesign(~1, probs = ~1, data = nwts_pop, strata = NULL, fpc = nrow(nwts_pop) + 1000)
des <- svydesign(~1, probs = ~1, data = nwts_pop, strata = ~1, fpc = nrow(nwts_pop) + 1000)
des <- svydesign(~1, probs = ~1, data = nwts_pop, strata = ~1, fpc = nrow(nwts_pop))
des <- svydesign(~1, probs = ~1, data = nwts_pop, strata = ~1, fpc = 1)
des <- svydesign(~1, probs = ~1, data = nwts_pop, fpc = 1)
des <- svydesign(~1, probs = ~1, data = nwts_pop, fpc = 0.9)
des <- svydesign(~1, weights = ~1, data = nwts_pop, fpc = 0.9)
des <- svydesign(~1, weights = ~1, data = nwts_pop, fpc = ~0.9)
des <- svydesign(~1, weights = ~1, data = nwts_pop, fpc = ~1)
des <- svydesign(~1, weights = ~1, data = nwts_pop, fpc = 1)
des <- svydesign(~1, weights = ~1, data = nwts_pop, fpc = 0.5)
des <- svydesign(~1, data = nwts_pop, fpc = 0.5)
des <- svydesign(~1, data = nwts_pop, fpc = 1)
des <- svydesign(~1, data = nwts_pop, fpc = 10000)
table(nwts_pop$strat4)
des <- svydesign(~1, strata = strat4, data = nwts_pop, fpc = table(nwts_pop$strat4))
strat_counts <- table(nwts_pop$strat4)
des <- svydesign(~1, strata = strat4, data = nwts_pop, fpc = strat_counts)
des <- svydesign(~1, strata = ~strat4, data = nwts_pop, fpc = strat_counts)
strat_counts <- table(nwts_pop$strat4)*2
des <- svydesign(~1, strata = ~strat4, data = nwts_pop, fpc = strat_counts)
colSums(model.frame(~strat4), data = nwts_pop)
colSums(model.frame(~strat4, data = nwts_pop)
)
colSums(model.frame(~strat4, data = nwts_pop))
colSums(model.frame(~as.factor(strat4), data = nwts_pop))
model.frame(~factor(strat4), data = nwts_pop)
colSums(model.matrix(~factor(strat4), data = nwts_pop))
colSums(model.matrix(~strat4, data = nwts_pop))
colSums(model.matrix(~factor(strat4), data = nwts_pop))
des <- svydesign(~1, strata = ~strat4, data = nwts_pop, fpc = colSums(model.matrix(~factor(strat4), data = nwts_pop)))
des <- svydesign(~1, strata = ~factor(strat4), data = nwts_pop, fpc = colSums(model.matrix(~factor(strat4), data = nwts_pop)))
des <- svydesign(~1, strata = ~factor(strat4), data = nwts_pop)
des <- svydesign(~1, probs = 1, strata = ~factor(strat4), data = nwts_pop)
des <- svydesign(~1, probs = 1, strata = ~factor(strat4), data = nwts_pop, fpc = colSums(model.matrix(~factor(strat4), data = nwts_pop)))
des <- svydesign(~1, probs = 1, strata = ~factor(strat4), data = nwts_pop,
fpc = 2*colSums(model.matrix(~factor(strat4), data = nwts_pop)))
colSums(model.matrix(~factor(strat4), data = nwts_pop))
colSums(model.matrix(~factor(strat4), data = nwts_pop))/nrow(nwts_pop)
colSums(model.matrix(~factor(strat4)-1, data = nwts_pop))/nrow(nwts_pop)
fpc_counts <- colSums(model.matrix(~factor(strat4)-1, data = nwts_pop))/nrow(nwts_pop)
fpc_props <- colSums(model.matrix(~factor(strat4)-1, data = nwts_pop))/nrow(nwts_pop)
des <- svydesign(~1, probs = 1, strata = ~factor(strat4), data = nwts_pop,
fpc = unname(fpc_props))
fpc_props <- colSums(model.matrix(~factor(strat4)-1, data = nwts_pop))/nrow(nwts_pop)
des <- svydesign(~1, probs = 1, strata = ~factor(strat4), data = nwts_pop,
fpc = unname(fpc_props))
fpc_df <- data.frame(strata = 1:4, prop = fpc_props)
fpc_df <- data.frame(strata = 1:4, prop = 1)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strata")
fpc_df <- data.frame(strata = factor(1:4), prop = 1)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strata")
des <- svydesign(~1, probs = 1, strata = ~strat4, data = nwts_pop_fpc,
fpc = ~prop)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strata")
View(nwts_pop_fpc)
fpc_df <- data.frame(strata = factor(1:4), prop = 1)
levels(nwts_pop$strat4)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strat4")
fpc_df <- data.frame(strat4 = 1:4, prop = 1)
fpc_df
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strat4")
des <- svydesign(~1, probs = 1, strata = ~strat4, data = nwts_pop_fpc,
fpc = ~prop)
fpc_df <- data.frame(strat4 = 1:4, prop = 0.9)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strat4")
des <- svydesign(~1, probs = 1, strata = ~strat4, data = nwts_pop_fpc,
fpc = ~prop)
fpc_df <- data.frame(strat4 = 1:4, prop = 0.99)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strat4")
des <- svydesign(~1, probs = 1, strata = ~strat4, data = nwts_pop_fpc,
fpc = ~prop)
m4 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = des)
confint(m4)
confint(m3)
confint(m2)
confint(m1a)
library(survey)
# also consider
# data(nwts2ph, package = "addhazard")
data(nwtsco, package = "addhazard")
nwts <- nwtsco
# set up strata
nwts <- nwts |>
dplyr::mutate(instit = factor(instit, c(0, 1), labels = c("FH", "UH")),
stage4 = stage == 4,
stage = factor(stage, levels = 1:4,
labels = c("I-II", "I-II",
"III-IV", "III-IV")),
age_bin = factor(0 + age<1,
labels = c("<1Yr", ">=1Yrs")),
strata =interaction(instit, stage, age_bin, relaps))
## collapse smallest 13 strata together.
s_counts <- nwts |>
dplyr::count(strata) |>
dplyr::arrange(desc(n)) |>
dplyr::mutate(rank = dplyr::row_number()) |>
dplyr::mutate(strat4 = dplyr::if_else(rank <= 3, rank, 4L)) |>
dplyr::group_by(strat4) |>
dplyr::mutate(weight = dplyr::case_when(strat4 == 1 ~ n/120,
strat4 == 2 ~ n/160,
strat4 == 3 ~ n/120,
TRUE ~ 1))
nwts_join <- dplyr::left_join(nwts, dplyr::select(s_counts, strata, strat4, weight)) |>
dplyr::mutate(id = dplyr::row_number())
nwts_pop <- nwts_join
# draw the complex sample.
nwts_samp <- dplyr::bind_rows(
dplyr::filter(nwts_pop, strat4 == 1) |>
dplyr::slice_sample(n = 120),
dplyr::filter(nwts_pop, strat4 == 2) |>
dplyr::slice_sample(n = 160),
dplyr::filter(nwts_pop, strat4 == 3) |>
dplyr::slice_sample(n = 120),
dplyr::filter(nwts_pop, strat4 == 4))
nwts_pop$in.subsample <- nwts_pop$id %in% nwts_samp$id
# fit imptation model
impmodel <- glm(histol~instit + age_bin + stage4*study, data = nwts_pop, subset = in.subsample, family = binomial )
# predict histology for everyone
nwts_pop$imphist <- predict(impmodel, newdata = nwts_pop, type = "response")
# replace predicted histology with actual histology where available (i.e. sampled children)
nwts_pop$imphist[nwts_pop$in.subsample] <- nwts$histol[nwts_pop$in.subsample]
# fit a model to the population data supplemented with the imputed histology
ifmodel <- coxph(Surv(trel, relaps) ~ imphist * age + stage * tumdiam, data = nwts_pop)
# append influence functions to the pop data
inffun <- resid(ifmodel, "dfbeta")
colnames(inffun) <- paste0("if", seq(ncol(inffun)))
nwts_pop_if <- cbind(nwts_pop, inffun)
if_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_pop_if, subset = ~in.subsample)
pop_totals <- colSums(model.matrix(~ if1 + if2 + if3 + if4 + if5 + strat4,
data = nwts_pop_if))
if_cal <- calibrate(if_design, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4,
population = pop_totals)
# design with sample data. same as if_design
nwts_design <- svydesign(~1, strata = ~strat4, weights = ~weight,
data = nwts_samp)
# fit a model using the uncalibrated design
m0 <- svycoxph(Surv(trel, relaps) ~  histol * age + stage * tumdiam, design = if_design)
cal_form <- ~ imphist * age + stage * tumdiam
pop_totals <- colSums(model.matrix(cal_form, data = nwts_pop))
# calibrate the weights using pop totals
var_cal <- calibrate(if_design, formula = cal_form,
pop=pop_totals) # dropped , bounds = c(0.1, 10)
# fit a model using the variable calibrated design
m1 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = var_cal)
# fit a model using the influence function calibrated design with imputation
m1a <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = if_cal)
# regular cox regression on the population data
m2 <- coxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, data = nwts_pop_if)
# Uncalibrated design
(m0_summary <- coef(summary(m0)))
# Calibrated with population variables # really biased?
(m1_summary <- coef(summary(m1)))
# Calibrated with population influence functions using imputed data
(m1a_summary <- coef(summary(m1a)))
m2_summary <- coef(summary(m2))
### influence function calibration without imputation (instit swapped for histol)
popmodel <- coxph(Surv(trel, relaps) ~ instit * age + stage * tumdiam,
data = nwts_pop, na.action = na.exclude)
# extract the dfbetas from this pop-level fit.
inffun <- resid(popmodel, "dfbeta")
# add the influence functions to the design
index <- match(nwts_samp$id, nwts_pop$id)
nwts_design_if <- update(nwts_design,
if1 = inffun[index, 1],
if2 = inffun[index, 2],
if3 = inffun[index, 3],
if4 = inffun[index, 4],
if5 = inffun[index, 5])
# calibrate using the influence functions
if_cal <- calibrate(nwts_design_if,
formula = ~if1 + if2 + if3 + if4 + if5,
pop = c(pop_totals[1], if1 = 0, if2 = 0, if3 = 0, if4 = 0, if5 = 0))
# fit a model using the IF calibrated design
m3 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = if_cal)
(m3_summary <- coef(summary(m3)))
m2_summary
m1a_summary
# the imputed CI is narrower than the population fit. FPC correction? the CI for coxph is wrong without it.
confint(m3)
confint(m2)
confint(m1a)
fpc_props <- colSums(model.matrix(~factor(strat4)-1, data = nwts_pop))/nrow(nwts_pop)
fpc_df <- data.frame(strat4 = 1:4, prop = 0.99)
nwts_pop_fpc <- dplyr::left_join(nwts_pop, fpc_df, by = "strat4")
des <- svydesign(~1, probs = 1, strata = ~strat4, data = nwts_pop_fpc,
fpc = ~prop)
m4 <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = des)
confint(m4)
confint(m3)
confint(m2)
confint(m1a)
# design with pop data
if_design_tp <- twophase(id = list(~1, ~1), subset = ~in.subsample,
strata = list(NULL, ~strat4), data = nwts_pop_if)
if_cal <- calibrate(if_design_tp, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4,
population = pop_totals)
if_cal <- calibrate(if_design_tp, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4)
if_cal_tp <- calibrate(if_design_tp, phase = 2, calfun = "raking",
formula = ~ if1 + if2 + if3 + if4 + if5 + strat4)
# same, but with the twophase design
m1a_tp <- svycoxph(Surv(trel, relaps) ~ histol * age + stage * tumdiam, design = if_cal_tp)
confint(m1a)
confint(m1a_tp)
usethis::edit_r_profile()
interactive()
if(interactive()) {
}
if(interactive()) {
invisible()
}
usethis::edit_r_profile()
library(coxme)
install.packages("coxme")
library(coxme)
vignette(package = "coxme")
vignette("variance", package = "coxme")
data(gexchange)
seq(from = 0, to = 10, by = 1)
log(seq(from = 0, to = 10, by = 1))
log(Inf)
log(1000000000000000000)
pmax(1000)
